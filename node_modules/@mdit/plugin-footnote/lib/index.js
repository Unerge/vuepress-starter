const b=(e,t)=>e[t].meta.subId>0?`:${e[t].meta.subId}`:"",$=(e,t,l,c)=>`${typeof c.docId=="string"?`-${c.docId}-`:""}${(e[t].meta.id+1).toString()}`,v=(e,t)=>`[${(e[t].meta.id+1).toString()}${b(e,t)}]`,g=(e,t,l,c,n)=>{const s=n.rules.footnote_anchorName(e,t,l,c,n),r=n.rules.footnote_caption(e,t,l,c,n);return`<sup class="footnote-ref"><a href="#footnote${s}">${r}</a><a class="footnote-anchor" id="footnote-ref${s}${b(e,t)}" /></sup>`},A=(e,t,l)=>`<hr class="footnotes-sep"${l.xhtmlOut?" /":""}>
<section class="footnotes">
<ol class="footnotes-list">
`,I=()=>`</ol>
</section>
`,T=(e,t,l,c,n)=>`<li id="footnote${n.rules.footnote_anchorName(e,t,l,c,n)}${b(e,t)}" class="footnote-item">`,M=()=>`</li>
`,w=(e,t,l,c,n)=>` <a href="#footnote-ref${n.rules.footnote_anchorName(e,t,l,c,n)}${b(e,t)}" class="footnote-backref">↩︎</a>`,y=(e,t,l,c)=>{const n=e.bMarks[t]+e.tShift[t],s=e.eMarks[t];if(n+4>s||e.src.charAt(n)!=="["||e.src.charAt(n+1)!=="^")return!1;let r=n+2;for(;r<s;){if(e.src.charAt(r)===" ")return!1;if(e.src.charAt(r)==="]")break;r++}if(r===n+2||r+1>=s||e.src.charAt(++r)!==":")return!1;if(c)return!0;r++,(e.env.footnotes??={}).refs??={};const o=e.src.slice(n+2,r-2);e.env.footnotes.refs[`:${o}`]=-1;const f=e.push("footnote_reference_open","",1);f.meta={label:o},f.level=e.level++;const p=e.bMarks[t],i=e.tShift[t],a=e.sCount[t],u=e.parentType,h=r,d=e.sCount[t]+r-(e.bMarks[t]+e.tShift[t]);let k=e.sCount[t]+r-(e.bMarks[t]+e.tShift[t]);for(;r<s;){const _=e.src.charAt(r);if(_==="	")k+=4-k%4;else if(_===" ")k++;else break;r++}e.tShift[t]=r-h,e.sCount[t]=k-d,e.bMarks[t]=h,e.blkIndent+=4,e.parentType="footnote",e.sCount[t]<e.blkIndent&&(e.sCount[t]+=e.blkIndent),e.md.block.tokenize(e,t,l),e.parentType=u,e.blkIndent-=4,e.tShift[t]=i,e.sCount[t]=a,e.bMarks[t]=p;const m=e.push("footnote_reference_close","",-1);return m.level=--e.level,!0},S=(e,t)=>{const l=e.posMax,c=e.pos;if(c+2>=l||e.src.charAt(c)!=="^"||e.src.charAt(c+1)!=="[")return!1;const n=e.md.helpers.parseLinkLabel(e,c+1);if(n<0)return!1;const s=c+2;if(!t){const r=((e.env.footnotes??={}).list??=[]).length,o=[];e.md.inline.parse(e.src.slice(s,n),e.md,e.env,o);const f=e.push("footnote_ref","",0);f.meta={id:r},e.env.footnotes.list[r]={content:e.src.slice(s,n),tokens:o}}return e.pos=n+1,e.posMax=l,!0},C=(e,t)=>{const l=e.pos,c=e.posMax;if(l+3>c||!e.env.footnotes?.refs||e.src.charAt(l)!=="["||e.src.charAt(l+1)!=="^")return!1;let n=l+2;for(;n<c;){if(e.src.charAt(n)===" "||e.src.charAt(n)===`
`)return!1;if(e.src.charAt(n)==="]")break;n++}if(n===l+2||n>=c)return!1;n++;const s=e.src.slice(l+2,n-1);if(typeof e.env.footnotes.refs[`:${s}`]>"u")return!1;if(!t){const r=e.env.footnotes.list??=[],{refs:o}=e.env.footnotes;let f;o[`:${s}`]<0?(f=r.length,r[f]={label:s,count:0},o[`:${s}`]=f):f=o[`:${s}`];const p=r[f].count;r[f].count=r[f].count+1;const i=e.push("footnote_ref","",0);i.meta={id:f,subId:p,label:s}}return e.pos=n,e.posMax=c,!0},x=e=>{const t={};let l,c,n=!1;if(!e.env.footnotes?.list)return!1;const{list:s}=e.env.footnotes;e.tokens=e.tokens.filter(o=>o.type==="footnote_reference_open"?(n=!0,l=[],c=o.meta.label,!1):o.type==="footnote_reference_close"?(n=!1,t[`:${c}`]=l,!1):(n&&l.push(o),!n));const r=new e.Token("footnote_block_open","",1);e.tokens.push(r);for(let o=0,{length:f}=s;o<f;o++){const p=new e.Token("footnote_open","",1);p.meta={id:o,label:s[o].label},e.tokens.push(p);let i;if(s[o].tokens){const a=new e.Token("paragraph_open","p",1);a.block=!0;const u=new e.Token("inline","",0);u.children=s[o].tokens,u.content=s[o].content;const h=new e.Token("paragraph_close","p",-1);h.block=!0,e.tokens.push(a,u,h)}else if(s[o].label){const a=t[`:${s[o].label}`];a&&e.tokens.push(...a)}e.tokens[e.tokens.length-1].type==="paragraph_close"?i=e.tokens.pop()??null:i=null;for(let a=0;a<(Number(s[o].count)>0?s[o].count:1);a++){const u=new e.Token("footnote_anchor","",0);u.meta={id:o,subId:a,label:s[o].label},e.tokens.push(u)}i&&e.tokens.push(i),e.tokens.push(new e.Token("footnote_close","",-1))}return e.tokens.push(new e.Token("footnote_block_close","",-1)),!0},N=e=>{e.renderer.rules.footnote_ref=g,e.renderer.rules.footnote_block_open=A,e.renderer.rules.footnote_block_close=I,e.renderer.rules.footnote_open=T,e.renderer.rules.footnote_close=M,e.renderer.rules.footnote_anchor=w,e.renderer.rules.footnote_caption=v,e.renderer.rules.footnote_anchorName=$,e.block.ruler.before("reference","footnoteDef",y,{alt:["paragraph","reference"]}),e.inline.ruler.after("image","footnoteInline",S),e.inline.ruler.after("footnoteInline","footnote_ref",C),e.core.ruler.after("inline","footnoteTail",x)};export{N as footnote};
//# sourceMappingURL=index.js.map
